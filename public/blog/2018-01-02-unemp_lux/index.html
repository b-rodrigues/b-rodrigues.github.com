<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"  lang="en-us">
    <title>maps - Econometrics and Free Software</title>
    <meta name="generator" content="Hugo 0.25.1" />

    
    <meta name="description" content="A blog about econometrics, free software, and R">
    
    <link rel="canonical" href="../../blog/2018-01-02-unemp_lux/">
    
    <meta name="author" content="Bruno Rodrigues">
    
    <meta name="generator" content="Hugo 0.25.1" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:url" content="/blog/2018-01-02-unemp_lux/">
    <meta property="og:title" content="Econometrics and Free Software">
    <meta property="og:image" content="/map[height:50 alt:Logo url:logo.png width:50]">
    <meta name="apple-mobile-web-app-title" content="Econometrics and Free Software">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="shortcut icon" type="image/x-icon" href="../../images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="../../images/favicon.ico">

    
    <link rel="stylesheet" href="../../css/bootstrap.min.css" media="screen">
    <link rel="stylesheet" href="../../css/custom.css">
    <link rel="stylesheet" href="../../css/pygments.css">
    
    <link rel="stylesheet" href="../../css/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../css/helpers/jquery.fancybox-buttons.css?v=1.0.5" type="text/css" media="screen" />
  </head>
  <body>


<div class="row">
<div class="navbar navbar-default navbar-fixed-top">
<div class="container">
  <div class="navbar-header">
    <a href="../../" class="navbar-brand">Econometrics and Free Software</a>
    <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
  </div>
  <div class="navbar-collapse collapse" id="navbar-main">

    <ul class="nav navbar-nav navbar-right">
      <li><a href="https://bitbucket.org/b-rodrigues/">Bitbucket</a></li>
      <li><a href="https://github.com/b-rodrigues/">Github</a></li>
      <li><a href="https://twitter.com/brodriguesco/">Twitter</a></li>
    </ul>
  </div>
</div>

</div>

<div class="container">

  <div>
    <div class="row">
      <div class="col-lg-3 col-md-3 col-sm-4">
        

<div class="list-group table-of-contents">

  
    <a class="list-group-item" href=#><b>About Me</b></a>
    
    <div class="list-group">
      
      <a class="list-group-item" href="../../about/about/">Who am I?</a>
      
      <a class="list-group-item" href="../../about/projects/">Projects</a>
      
      <a class="list-group-item" href="../../about/research/">Research</a>
      
      <a class="list-group-item" href="../../about/software/">Software</a>
      
    </div>
    
  
    <a class="list-group-item" href=#><b>Blog</b></a>
    
    <div class="list-group">
      
      <a class="list-group-item" href="../../blog/2017-12-27-build_formulae/">Building formulae</a>
      
      <a class="list-group-item" href="../../blog/2017-10-26-margins_r/">Easy peasy STATA-like marginal effects with R</a>
      
      <a class="list-group-item" href="../../blog/2017-11-14-peace_r/">Functional peace of mind</a>
      
      <a class="list-group-item" href="../../blog/2017-12-17-teaching_tidyverse/">Teaching the tidyverse to beginners</a>
      
      <a class="list-group-item" href="../../blog/2017-08-27-why_tidyeval/">Why I find tidyeval useful</a>
      
      <a class="list-group-item" href="../../blog/2018-01-02-unemp_lux/">maps</a>
      
      <a class="list-group-item" href="../../blog/2017-07-27-spread_rename_at/">tidyr::spread() and dplyr::rename_at() in action</a>
      
      <a class="list-group-item" href="../../blog/2017-03-27-introducing_brotools/">Introducing brotools</a>
      
      <a class="list-group-item" href="../../blog/2017-06-19-dplyr-0-70-tutorial/">Lesser known dplyr 0.7* tricks</a>
      
      <a class="list-group-item" href="../../blog/2017-02-17-lesser_known_tricks/">Lesser known dplyr tricks</a>
      
      <a class="list-group-item" href="../../blog/2017-03-24-lesser_known_purrr/">Lesser known purrr tricks</a>
      
      <a class="list-group-item" href="../../blog/2017-03-29-make-ggplot2-purrr/">Make ggplot2 purrr</a>
      
      <a class="list-group-item" href="../../blog/2016-12-24-functional-programming-and-unit-testing-for-data-munging-with-r-available-on-leanpub/">Functional programming and unit testing for data munging with R available on Leanpub</a>
      
      <a class="list-group-item" href="../../blog/2017-02-17-how_to_use_jailbreakr/">How to use jailbreakr</a>
      
      <a class="list-group-item" href="../../blog/2017-01-07-my-free-book-has-a-cover/">My free book has a cover!</a>
      
      <a class="list-group-item" href="../../blog/2016-12-21-work-on-lists-of-datasets-instead-of-individual-datasets-by-using-functional-programming/">Work on lists of datasets instead of individual datasets by using functional programming</a>
      
      <a class="list-group-item" href="../../blog/2013-01-29-method-of-simulated-moments-with-r/">Method of Simulated Moments with R</a>
      
      <a class="list-group-item" href="../../blog/2012-12-11-new-website/">New website!</a>
      
      <a class="list-group-item" href="../../blog/2013-11-07-gmm-with-rmd/">Nonlinear Gmm with R - Example with a logistic regression</a>
      
      <a class="list-group-item" href="../../blog/2013-01-16-simulated-maximum-likelihood-with-r/">Simulated Maximum Likelihood with R</a>
      
      <a class="list-group-item" href="../../blog/2015-11-11-bootstrapping-did-with-r/">Bootstrapping standard errors for difference-in-differences estimation with R</a>
      
      <a class="list-group-item" href="../../blog/2016-06-21-careful-with-trycatch/">Careful with tryCatch</a>
      
      <a class="list-group-item" href="../../blog/2016-07-18-data-frame-columns-as-arguments-to-dplyr-functions/">Data frame columns as arguments to dplyr functions</a>
      
      <a class="list-group-item" href="../../blog/2015-02-22-export-r-output-to-file/">Export R output to a file</a>
      
      <a class="list-group-item" href="../../blog/2016-11-04-ive-started-writing-a-book-functional-programming-and-unit-testing-for-data-munging-with-r/">I&#39;ve started writing a &#39;book&#39;: Functional programming and unit testing for data munging with R</a>
      
      <a class="list-group-item" href="../../blog/2015-01-12-introduction-to-programming-econometrics-with-r/">Introduction to programming econometrics with R</a>
      
      <a class="list-group-item" href="../../blog/2016-07-30-merge-a-list-of-datasets-together/">Merge a list of datasets together</a>
      
      <a class="list-group-item" href="../../blog/2014-04-23-r-s4-rootfinding/">Object Oriented Programming with R: An example with a Cournot duopoly</a>
      
      <a class="list-group-item" href="../../blog/2014-11-11-benchmarks-r-blas-atlas-rro/">R, R with Atlas, R with OpenBLAS and Revolution R Open: which is fastest?</a>
      
      <a class="list-group-item" href="../../blog/2016-07-26-read-a-lot-of-datasets-at-once-with-r/">Read a lot of datasets at once with R</a>
      
      <a class="list-group-item" href="../../blog/2016-03-31-unit-testing-with-r/">Unit testing with R</a>
      
      <a class="list-group-item" href="../../blog/2015-05-03-update-introduction-r-programming/">Update to Introduction to programming econometrics with R</a>
      
      <a class="list-group-item" href="../../blog/2013-12-31-r-cas/">Using R as a Computer Algebra System with Ryacas</a>
      
    </div>
    
  

</div>

      </div>
      <div class="col-lg-9 col-md-9 col-sm-8">
        <div>
           <h1 id="main">maps</h1>
           <span class="article-date">December 27, 2017</span>
        </div>
        <p>In this blog post, I show various ways to create maps using R. You’ll need to install a lot of packages and download two data sets; the unemployment rate in Luxembourg as well as a shapefile.</p>
<p>To get the unemployment rate in Luxembourg, you can take a look at our <a href="http://rdata.lu/portfolio/2017-04-21-scraping-data-from-statec-s-public-tables/">previous blog post</a> or simply run the following lines:</p>
<pre class="r"><code>library(rvest)
library(dplyr)
library(purrr)
library(janitor)
library(tidyr)

page_unemp = read_html(&quot;http://www.statistiques.public.lu/stat/TableViewer/tableViewHTML.aspx?ReportId=12950&amp;IF_Language=eng&amp;MainTheme=2&amp;FldrName=3&amp;RFPath=91&quot;)

data_raw = page_unemp %&gt;%
  html_nodes(&quot;.b2020-datatable&quot;) %&gt;% .[[1]] %&gt;% html_table(fill = TRUE)

colnames(data_raw) = data_raw[1, ]

colnames(data_raw)[1:2] = c(&quot;division&quot;, &quot;variable&quot;)

data_raw = data_raw[-c(1,2), ]

unemp_lux = data_raw %&gt;%
  map_df(function(x)(gsub(&quot;,&quot;, &quot;.&quot;, x = x))) %&gt;%
  mutate_at(vars(matches(&quot;\\d{4}&quot;)), as.numeric) %&gt;%
  gather(key=year, value, -division, -variable) %&gt;%
  spread(variable, value) %&gt;%
  clean_names()</code></pre>
<p>These lines scrape the data off STATEC’s (the national institute of statistics) public tables and puts the raw data into a tidy data frame. Let’s take a look:</p>
<pre class="r"><code>head(unemp_lux)</code></pre>
<pre><code>##   division year active_population of_which_non_wage_earners
## 1 Beaufort 2001               688                        85
## 2 Beaufort 2002               742                        85
## 3 Beaufort 2003               773                        85
## 4 Beaufort 2004               828                        80
## 5 Beaufort 2005               866                        96
## 6 Beaufort 2006               893                        87
##   of_which_wage_earners total_employed_population unemployed
## 1                   568                       653         35
## 2                   631                       716         26
## 3                   648                       733         40
## 4                   706                       786         42
## 5                   719                       815         51
## 6                   746                       833         60
##   unemployment_rate_in_percent
## 1                         5.09
## 2                         3.50
## 3                         5.17
## 4                         5.07
## 5                         5.89
## 6                         6.72</code></pre>
<p>Once you have the unemployment data, install the next packages you’ll need to follow the rest of the post:</p>
<pre class="r"><code>install.packages(
  c(
    &quot;viridis&quot;,  # Optional, but better color scheme than the default 
    &quot;broom&quot;,    # For tidy()
    &quot;ggplot2&quot;,  # To create a basic map
    &quot;ggthemes&quot; # To change the theme of the map
    )</code></pre>
<p>Then install two further packages:</p>
<pre class="r"><code>install.packages(&#39;rgeos&#39;, type=&#39;source&#39;) # Dependency of rgdal
install.packages(&#39;rgdal&#39;, type=&#39;source&#39;) # To read in the shapefile</code></pre>
<p><code>rgdal</code> might be tricky to install on macOS and Linux. If you’re using Ubuntu, you have to install <code>libgdal-dev</code>, and on macOS you’ll need to install <code>gdal</code> using Homebrew.</p>
<p>There’s a final package to install, but you have to get it from Github (and thus need <code>devtools</code>):</p>
<pre class="r"><code>devtools::install_github(&quot;dgrtwo/gganimate&quot;)</code></pre>
<p>To draw a map, you will need a so-called shapefile. These files contain the geometry of the countries, regions, etc so that it is possible to plot them. The shapefile for Luxembourg can be obtained from <a href="https://data.public.lu/en/datasets/limites-administratives-du-grand-duche-de-luxembourg/">Luxembourg’s Open data Portal</a>.</p>
<p>Download the zip, and look for the file called <code>LIMADM_COMMUNES.shp</code>, which contains the geometry of the Luxembourgish communes. Leave it inside the folder <code>Limadmin_SHP</code>, as it contains other files needed by <code>rgdal::readOGR()</code> to read in the shapefile.</p>
<pre class="r"><code>library(broom)
library(dplyr)
library(purrr)
library(ggplot2)
library(viridis)
library(rgdal)
library(ggthemes)
library(gganimate)</code></pre>
<p>Now we can read the data, and do some basic cleaning. I comment every step, but run the code line by line to really understand what’s going on!</p>
<p>Read the shapefile:</p>
<pre class="r"><code>communes = readOGR(&quot;Limadmin_SHP/LIMADM_COMMUNES.shp&quot;)</code></pre>
<pre><code>## OGR data source with driver: ESRI Shapefile 
## Source: &quot;Limadmin_SHP/LIMADM_COMMUNES.shp&quot;, layer: &quot;LIMADM_COMMUNES&quot;
## with 105 features
## It has 4 fields</code></pre>
<pre><code>## Warning in readOGR(&quot;Limadmin_SHP/LIMADM_COMMUNES.shp&quot;): Z-dimension
## discarded</code></pre>
<p>“Convert” it to a data frame using broom::tidy(). In the past, this was made with <code>ggplot2::fortify()</code>:</p>
<pre class="r"><code>communes_df = broom::tidy(communes, region = &quot;COMMUNE&quot;)</code></pre>
<p>Remove the <em>cantons</em> from the data, as well as the unemployment rate for the whole country. Then only select the relevant columns and rename them in one go:</p>
<pre class="r"><code>unemp_lux = unemp_lux %&gt;%
  filter(!grepl(&quot;Canton&quot;, division), division != &quot;Grand Duchy of Luxembourg&quot;) %&gt;%
  select(commune = division, year, unemp_rate = unemployment_rate_in_percent)</code></pre>
<p>The name of two communes are written differently in the shapefile than in the data. We can change that using <code>gsub()</code>. Change “Haute-Sûre” to “Haute Sûre” in the unemployment data:</p>
<pre class="r"><code>unemp_lux$commune = gsub(&quot;Haute-Sûre&quot;, &quot;Haute Sûre&quot;, unemp_lux$commune)</code></pre>
<p>Change “Redange” to “Redange-sur-Attert” in the data frame containing the geometry of the communes:</p>
<pre class="r"><code>communes_df$id = gsub(&quot;Redange&quot;, &quot;Redange-sur-Attert&quot;, communes_df$id)</code></pre>
<p>Select relevant columns from the communes data frame, and rename them:</p>
<pre class="r"><code>communes_df = communes_df %&gt;%
    select(long, lat, commune = id) </code></pre>
<p>Finally, join the communes data frame (containing the geometry) with the unemployment data, by communes:</p>
<pre class="r"><code>final_data = left_join(communes_df, unemp_lux, by = &quot;commune&quot;)</code></pre>
<p>Let’s plot the unemployment rate for the latest available year:</p>
<pre class="r"><code>final_data2016 = final_data %&gt;%
  filter(year == 2016)</code></pre>
<p>First, let’s plot a basic map using <code>ggplot2</code>. Even if you’re not familiar with <code>ggplot2</code> the code below should be very straightforward:</p>
<pre class="r"><code>ggplot_map = ggplot() +
  geom_polygon(data = final_data2016,
               aes(x = long, y = lat, group = commune, fill = unemp_rate)) +
    labs(title = &quot;Unemployment rate in Luxembourg in 2016&quot;, 
         y = &quot;&quot;, x = &quot;&quot;, fill = &quot;Unemployment rate&quot;) + 
    theme_tufte() +
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank()) + 
    scale_fill_viridis()</code></pre>
<p>Finally, print the map:</p>
<pre class="r"><code>print(ggplot_map)</code></pre>
<p><img src="../../blog/2018-01-02-unemp_lux_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p>It is also possible to create a map per year using <code>facet_wrap()</code>:</p>
<pre class="r"><code>facet_map = ggplot() +
  geom_polygon(data = final_data,
               aes(x = long, y = lat, 
                   group = commune, fill = unemp_rate)) +
    labs(title = &quot;Unemployment rate in Luxembourg&quot;, y = &quot;&quot;, x = &quot;&quot;, fill = &quot;Unemployment rate&quot;) + 
    theme_tufte() + 
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank()) + 
    facet_wrap(~year) +
    scale_fill_viridis()

print(facet_map)</code></pre>
<p><img src="../../blog/2018-01-02-unemp_lux_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<p>We clearly see that unemployment has risen in Luxembourg these past 15 years. This series of maps are great for printing, but since you’re reading this on a screen, why not try to animate these maps? This is possible with <code>gganimate()</code>:</p>
<pre class="r"><code>library(gganimate)

map_anim = ggplot() +
    geom_polygon(data = final_data, 
                 aes(x = long, y = lat, group = group, fill = unemp_rate, frame = year)) +
    labs(title = &quot;Unemployment rate in Luxembourg&quot;, y = &quot;&quot;, x = &quot;&quot;, fill = &quot;Unemployment rate&quot;) + 
    theme_tufte() + 
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank()) + 
    scale_fill_viridis()


gganimate(map_anim, &quot;map_lux.mp4&quot;, interval = 2)</code></pre>
<p>You can create an <code>.mp4</code> video as well as a <code>.gif</code>. Just change the extension inside the <code>gganimate()</code> function. <img src="../../img/map_lux.gif" /></p>
<p>That’s it for now. In the next post, I will show you how to create interactive maps using R and javascript!</p>

      </div>
    </div>
  <div class="row">
    <div class="col-lg-9 col-md-9 col-sm-8 col-lg-offset-3 col-md-offset-3">
    <footer>
  <div class="row">
    <div class="col-lg-12">
      <p>Copyright 2017. <a> Bruno Rodrigues</a> </p>
      <p>Made with the HUGO theme <a href="https://github.com/adejoux/hugo-darkdoc-theme" rel="nofollow">darkdoc</a>.</p>
    </div>
  </div>
</footer>

</body>

    </div>
  </div>

</div>
</html>
<script>

  var api_url = '';

</script>
<script src="//code.jquery.com/jquery-2.2.3.min.js"></script>
<script src="../../js/application.js"></script>
<script type="text/javascript" src="../../js/jquery.fancybox.pack.js?v=2.1.5"></script>
<script type="text/javascript" src="../../js/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
<script type="text/javascript" src="../../js/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
<script type="text/javascript" src="../../js/helpers/jquery.fancybox-media.js?v=1.0.6"></script>
<script type="text/javascript">
  $(document).ready(function() {
    $(".fancybox").fancybox();
  });
</script>

